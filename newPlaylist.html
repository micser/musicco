<html>
	<head>
		<style>
			.previousAlbum { border: 1px red dotted; }
			.previousTrack { color: red; }
			.selected { color: orange; }
			.nextTrack { color: green; }
			.nextAlbum { border: 1px green dotted; }
			.left { float: left; }
			.right { float: right; }
			#player_container { width: 300px; }
			#album_art { height: 300px; background-size: contain; }
			#seek_bar { width: 300px; }
			#volume_bar { width: 50px; transform: rotate(270deg); }
		</style>
		<script type="text/javascript" src="lib/jquery/jquery-2.2.4.min.js"></script>
		<script>
			$(document).ready(function() {
				// ////////////////////
				// Global variables //
				// //////////////////

				var nowPlaying = {};
				var previousTrack = null;
				var nextTrack = null;
				var previousAlbum = null;
				var nextAlbum = null;
				var player = new Audio();
				player.autoplay = false;


				var playlist = $("#playlist").find("ul").map(function() {
					var album = {};
					album.tracks = $(this).find("li").map(function() {
						var song = {};
						song.artist = $(this).data("artist");
						song.album = $(this).data("album");
						song.title = $(this).data("title");
						song.year = $(this).data("year");
						song.parent = $(this).data("parent");
						song.name = $(this).data("name");
						song.poster = $(this).data("poster");
						return song;
					}).get();
					return album;
				}).get();

				var playlistJSON = JSON.stringify(playlist);
				console.log(playlist);
				console.log(playlistJSON);
				var playlistFromString = JSON.parse(playlistJSON);
				$.each(playlistFromString, function (i, album) {
					var html = "<li><ul>"
						if (album.tracks) {
							$.each(album.tracks, function (j, track) {
								html += "<li";
								$.each(track, function(k,v) {
									html += ' data-' + k + '="' + v + '"';
								});
								html += ">" + track.title;
								html += "</li>";
							});
						}
					html += "</ul></li>";
				$("#playlist_copy").append(html);
				});

				/////////////
				// Events //
				///////////

				player.onended = function() { 
					// TODO: handle random here
					playTrack(nextTrack); 
				};

				player.onplay = function() {
					updatePlayerUI();
				}

				player.ondurationchange = function() {
					var duration = player.duration;
					$("#duration").html(getDuration(duration));
					$("#seek_bar").attr("max", parseInt(duration));
				}

				player.ontimeupdate = function() {
					var currentTime = player.currentTime;
					$("#current_time").html(getDuration(currentTime));
					$("#seek_bar").val(parseInt(currentTime));
				}

				$("#volume_bar").on("change", function() {
					player.volume = $(this).val() / 100;
				});

				$("#seek_bar").on("change", function() {
					player.currentTime = $(this).val();
				});

				$("#playlist > li > ul > li").on("click", function() {
					playTrack($(this));
				});

				$(".previous_album").on("click", function() {
					$(previousAlbum).find("li").first().trigger("click");
				});

				$(".previous_track").on("click", function() {
					$(previousTrack).trigger("click");
				});

				$(".play").on("click", function() {
					player.play();
				});

				$(".pause").on("click", function() {
					player.pause();
				});

				$(".next_track").on("click", function() {
					$(nextTrack).trigger("click");
				});

				$(".next_album").on("click", function() {
					$(nextAlbum).find("li").first().trigger("click");
				});

				$(".mute").on("click", function() {
					player.volume = 0;
				});

				$(".unmute").on("click", function() {
					player.volume = 1;
				});

				////////////////
				// Functions //
				//////////////

				function playTrack(track) {
					$("#playlist li").removeClass("selected previousAlbum previousTrack nextTrack nextAlbum ");
					$(track).addClass("selected");
					$.each($(track).data(), function(key, value) { nowPlaying[key] = value; });
					player.src = $(track).data("parent") + $(track).data("name");
					player.play();
					previousAlbum = $(track).parents("li").prev();
					previousTrack = $(track).prev("li");
					nextTrack = $(track).next("li");
					nextAlbum = $(track).parents("li").next();
					if (nextAlbum.length == 0) {
						nextAlbum = $("#playlist > li").first();
					}
					if (previousAlbum.length == 0) {
						previousAlbum = $("#playlist > li").last();
					}
					if (nextTrack.length == 0) {
						nextTrack = $(nextAlbum).find("li").first();
					}
					if (previousTrack.length == 0) {
						previousTrack = $(previousAlbum).find("li").last();
					}
					$(previousAlbum).addClass("previousAlbum");
					$(previousTrack).addClass("previousTrack");
					$(nextTrack).addClass("nextTrack");
					$(nextAlbum).addClass("nextAlbum");
					preload($(previousTrack));
					preload($(nextTrack));
				}

				function preload(track) {
					var altAudio = new Audio();
					altAudio.src = $(track).data("parent") + $(track).data("name");
				}

				function updatePlayerUI() {
					$("#album_art").css("background-image", 'url("' + nowPlaying["poster"] + '")'); 
					var textData = ["title", "artist", "album", "year"];
					textData.forEach(function(info) {
						$("#"+info).html(nowPlaying[info]); 
					});
				}

				function getDuration(seconds) {
					var date = new Date(null);
					date.setSeconds(seconds);
					var timeString = date.toISOString().substr(11, 8);
					if (timeString.substr(0, 2) == "00") {
						timeString = timeString.substr(3);
					}
					return timeString;
				}
			});
		</script>
	</head>
	<body>
		<div id="player_container">
			<div id="album_art"></div>
			<div id="progress_container">
				<input type="range" id="seek_bar" value="0" min="0" max=""/>
				<span id="current_time" class="left"></span>
				<span id="duration" class="right"></span>
			</div>
			<br/>
			<div id="controls">
				<span class="previous_album"><<--</span>
				<span class="previous_track"><--</span>
				<span class="play">play</span>
				<span class="pause">pause</span>
				<span class="next_track">--></span>
				<span class="next_album">-->></span>
				<br/>
				<span class="mute">mute</span>
				<span class="unmute">unmute</span>
				<input type="range" class="right" id="volume_bar" value="100" min ="0" max="100"/>
			</div>
			<div id="title"></div>
			<div id="artist"></div>
			<div id="album"></div>
			<div id="year"></div>
		</div>
		<div id="playlist_container">
			<ul id="playlist">
				<li>
					<ul>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Vegas" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="01_Vegas.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Vegas</li>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="September" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="02_September.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">September</li>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
					</ul>
				</li>
				<li>
					<ul>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
						<li data-artist="Breton" data-album="Other People's Problems" data-title="Pacemaker" data-year="2002" data-parent="music/Breton__/[2012] Other People's Problems/" data-name="01_Pacemaker.mp3" data-poster="music/Breton__/Other People's Problems/cover.png">Pacemaker</li>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
					</ul>
				</li>
				<li>
					<ul>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
						<li data-artist="1973" data-album="Bye Bye Cellphone" data-title="Intro" data-year="2001" data-parent="music/1973/Bye Bye Cellphone/" data-name="00_Intro.mp3" data-poster="music/1973/Bye Bye Cellphone/1973_Bye Bye Cellphone_Cover.png">Intro</li>
						<li data-artist="65daysofstatic" data-album="The Fall of Math" data-title="The Fall of Math" data-year="2004" data-parent="music/65daysofstatic/[2004] The Fall of Math/" data-name="02_Install A Beak In The Heart That Clucks Time In Arabic.mp3" data-poster="music/65daysofstatic/[2004] The Fall of Math/cover.png">The Fall of Math</li>
					</ul>
				</li>
			</ul>
			<ul id="playlist_copy"></ul>
		</div>
	</body>
</html>